name: Check DoctorQube Number (Multi-site Debug)

on:
  workflow_dispatch:
  schedule:
    - cron: "*/5 * * * *"

jobs:
  check:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Read site list
        id: read_sites
        run: |
          jq -c '.sites[]' sites.json > sites_list.txt
          echo "[DEBUG] Sites loaded:"
          cat sites_list.txt

      - name: Process each site
        run: |
          set -euo pipefail

          # 全角 → 半角変換
          z2h() {
            echo "$1" | tr '０１２３４５６７８９' '0123456789'
          }

          mkdir -p results
          mkdir -p pages

          while read SITE; do
            NAME=$(echo "$SITE" | jq -r '.name')
            URL=$(echo "$SITE" | jq -r '.url')
            echo "[INFO] Processing $NAME ($URL)"

            # HTML取得
            curl -s "$URL" > "pages/${NAME}.html"
            TEXT=$(sed 's/<[^>]*>//g' "pages/${NAME}.html")
            echo "$TEXT" > "pages/${NAME}.txt"

            # 数値抽出（全角対応）
            RAW_CURRENT=$(echo "$TEXT" | grep -oP '診療中\s*\K[０-９0-9]+' | head -n 1 || true)
            CURRENT=$(z2h "$RAW_CURRENT" | tr -d ' ')

            RAW_ABSENT=$(echo "$TEXT" | grep -oP 'ご不在の方\s*\K[０-９0-9,、\s]+' | head -n 1 || true)
            ABSENT=$(z2h "$RAW_ABSENT" | tr '、' ',' | tr -d ' ')

            RAW_NEXT=$(echo "$TEXT" | grep -oP '次にお取りできる番号\s*\K[０-９0-9]+' | head -n 1 || true)
            NEXT=$(z2h "$RAW_NEXT" | tr -d ' ')

            echo "[DEBUG][$NAME] CURRENT='$CURRENT' ABSENT='$ABSENT' NEXT='$NEXT'"

            # 差分比較
            STATE_FILE="results/${NAME}_state.json"
            NEW_STATE="{\"current\": \"$CURRENT\", \"absent\": \"$ABSENT\", \"next\": \"$NEXT\"}"

            CHANGE_FLAG="results/${NAME}_changed.flag"
            if [ ! -f "$STATE_FILE" ] || [ "$(cat "$STATE_FILE")" != "$NEW_STATE" ]; then
              echo "changed" > "$CHANGE_FLAG"
            fi

            echo "$NEW_STATE" > "${STATE_FILE}.new"

          done < sites_list.txt

      - name: Notify Slack for changed sites
        run: |
          while read SITE; do
            NAME=$(echo "$SITE" | jq -r '.name')

            CHANGE_FLAG="results/${NAME}_changed.flag"
            if [ ! -f "$CHANGE_FLAG" ]; then
              continue
            fi

            STATE_NEW="results/${NAME}_state.json.new"
            CURRENT=$(jq -r '.current' "$STATE_NEW")
            ABSENT=$(jq -r '.absent' "$STATE_NEW")
            NEXT=$(jq -r '.next' "$STATE_NEW")

            MESSAGE="*${NAME}*\n番号が更新されました\n・診療中: ${CURRENT}\n・ご不在: ${ABSENT}\n・次番号: ${NEXT}"

            curl -X POST \
              -H 'Content-type: application/json' \
              --data "{\"text\":\"$MESSAGE\"}" \
              "${{ secrets.SLACK_WEBHOOK_URL }}"

          done < sites_list.txt

      - name: Save new states
        run: |
          while read SITE; do
            NAME=$(echo "$SITE" | jq -r '.name')
            mv "results/${NAME}_state.json.new" "results/${NAME}_state.json"
          done < sites_list.txt

          git config user.name github-actions
          git config user.email github-actions@github.com
          git add results
          git commit -m "Update states" || true
          git push || true

      - name: Upload debug artifacts
        uses: actions/upload-artifact@v4
        with:
          name: debug-pages
          path: |
            pages/
            results/
