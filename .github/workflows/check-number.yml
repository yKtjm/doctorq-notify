name: Check DoctorQube Number (Multi-site Safe)

on:
  workflow_dispatch:
  schedule:
    - cron: "*/5 * * * *"

jobs:
  check:
    runs-on: ubuntu-slim

    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Read site list
        id: read_sites
        run: |
          jq -c '.[]' sites.json > sites_list.txt
          echo "[DEBUG] Sites loaded:"
          cat sites_list.txt

      - name: Process each site safely
        run: |
          set -euo pipefail

          mkdir -p results pages

          # 全角 → 半角
          z2h() { echo "$1" | perl -CSD -pe 'tr/０-９/0-9/'; }

          while read SITE; do
            NAME=$(echo "$SITE" | jq -r '.name')
            URL=$(echo "$SITE" | jq -r '.url')

            # サイトごとのルールを動的に抽出
            RULES=$(echo "$SITE" | jq -r '.rules')

            echo "[INFO] Processing $NAME ($URL)"

            # HTML取得 & テキスト化
            curl -s "$URL" > "pages/${NAME}.html"
            TEXT=$(sed 's/<[^>]*>//g' "pages/${NAME}.html")
            echo "$TEXT" > "pages/${NAME}.txt"

            # ---- 複数マッチ抽出（安全版） ----
            extract_matches() {
              local RULE="$1"
              local INPUT="$2"
              local OUT=""

              MATCHES=$(printf "%s" "$INPUT" | LC_ALL=C grep -oP "$RULE" || true)

              if [ -n "$MATCHES" ]; then
                while IFS= read -r v; do
                  VAL=$(printf "%s" "$v" | perl -CS -pe "s/${RULE}/\$1/")
                  VAL=$(printf "%s" "$VAL" | perl -CS -pe 'tr/０-９/0-9/')
                  OUT+="$VAL"$'\n'
                done <<< "$MATCHES"
              fi

              printf "%s" "$OUT"
            }

            # 各ルールに対してマッチングを実行
            RULE_MATCHES=""
            while IFS="=" read -r RULE_NAME RULE_PATTERN; do
              MATCH_RESULT=$(extract_matches "$RULE_PATTERN" "$TEXT")
              if [ -n "$MATCH_RESULT" ]; then
                INDENTED=$(printf "%s" "$MATCH_RESULT" | sed 's/^/  - /')
                RULE_MATCHES+="・$RULE_NAME:\n$INDENTED"$'\n'
              fi
            done <<< "$(echo "$RULES" | jq -r 'to_entries | .[] | "\(.key)=\(.value)"')"

            # デバッグ出力
            echo "[DEBUG][$NAME] Matched rules:"
            echo "$RULE_MATCHES"

            # JSON に保存
            NEW_STATE_FILE="results/${NAME}_state.json.new"
            jq -n --arg r "$RULE_MATCHES" '{rules:$r}' > "$NEW_STATE_FILE"

            STATE_FILE="results/${NAME}_state.json"
            CHANGE_FLAG="results/${NAME}_changed.flag"

            # 差分比較
            if [ ! -f "$STATE_FILE" ] || [ "$(jq -S . "$STATE_FILE")" != "$(jq -S . "$NEW_STATE_FILE")" ]; then
              echo "changed" > "$CHANGE_FLAG"
            fi

          done < sites_list.txt

      - name: Notify Slack for changed sites
        run: |
          while read SITE; do
            NAME=$(echo "$SITE" | jq -r '.name')
            URL=$(echo "$SITE" | jq -r '.url')
            CHANGE_FLAG="results/${NAME}_changed.flag"
            [ -f "$CHANGE_FLAG" ] || continue

            STATE_NEW="results/${NAME}_state.json.new"
            RULE_MATCHES=$(jq -r '.rules' "$STATE_NEW")

            # 全項目空なら通知しない
            if [ -z "$RULE_MATCHES" ]; then
              echo "[INFO] Skip Slack: no matched rules for $NAME"
              continue
            fi

            # ルール名と値をコロン区切りで表示
            MESSAGE="*${NAME}*\n番号が更新されました\n${RULE_MATCHES}\n${URL}"

            curl -X POST -H 'Content-type: application/json' \
              --data "{ \"channel\": \"#${NAME}\", \"text\": \"${MESSAGE}\" }" \
              "${{ secrets.SLACK_WEBHOOK_URL }}"

          done < sites_list.txt

      - name: Save new states
        run: |
          while read SITE; do
            NAME=$(echo "$SITE" | jq -r '.name')
            mv "results/${NAME}_state.json.new" "results/${NAME}_state.json"
          done < sites_list.txt

          git config user.name github-actions
          git config user.email github-actions@github.com
          git add results
          git commit -m "Update states" || true
          git push || true

      - name: Upload debug artifacts
        uses: actions/upload-artifact@v4
        with:
          name: debug-pages
          path: |
            pages/
            results/
