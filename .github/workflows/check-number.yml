name: Check DoctorQube Number (Multi-site Safe)

on:
  workflow_dispatch:
  schedule:
    - cron: "*/5 * * * *"

jobs:
  check:
    runs-on: ubuntu-slim

    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Read site list
        id: read_sites
        run: |
          jq -c '.[]' sites.json > sites_list.txt
          echo "[DEBUG] Sites loaded:"
          cat sites_list.txt

      - name: Process each site safely
        run: |
          set -euo pipefail

          mkdir -p results pages

          # å…¨è§’ â†’ åŠè§’
          z2h() { echo "$1" | perl -CSD -pe 'tr/ï¼-ï¼™/0-9/'; }

          # ---- åˆå‰/åˆå¾Œã‚»ã‚¯ã‚·ãƒ§ãƒ³æ¤œå‡º ----
          annotate_section() {
            local INPUT="$1"
            local CURRENT_PREFIX=""
            echo "$INPUT" | while IFS= read -r line; do
              # ã‚»ã‚¯ã‚·ãƒ§ãƒ³è¦‹å‡ºã—æ¤œå‡ºï¼ˆåˆå‰ãƒ»åˆå¾Œï¼‰
              if echo "$line" | grep -q 'åˆå‰'; then
                CURRENT_PREFIX="åˆå‰ï¼š"
              elif echo "$line" | grep -q 'åˆå¾Œ'; then
                CURRENT_PREFIX="åˆå¾Œï¼š"
              fi
              printf "[%s]%s\n" "$CURRENT_PREFIX" "$line"
            done
          }

          # ---- æ­£è¦è¡¨ç¾ãƒãƒƒãƒï¼ˆprefix ã‚’ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‹ã‚‰å–å¾—ï¼‰ ----
          extract_matches() {
            local RULE="$1"
            local INPUT="$2"
            local OUT=""

            # å„è¡Œã® prefixï¼ˆåˆå‰/åˆå¾Œï¼‰ã‚’æ®‹ã—ãŸçŠ¶æ…‹ã§ RULE ã‚’æ¤œç´¢ã™ã‚‹
            MATCH_LINES=$(printf "%s" "$INPUT" | grep -nP "$RULE" || true)
            if [ -n "$MATCH_LINES" ]; then
              while IFS= read -r ml; do
                # è¡Œç•ªå·ã¨å†…å®¹ã«åˆ†é›¢
                local ln=$(echo "$ml" | cut -d: -f1)
                local line=$(echo "$ml" | cut -d: -f2-)

                # prefix æŠ½å‡ºï¼ˆ "[åˆå‰ï¼š]..." â†’ "åˆå‰ï¼š" ï¼‰
                local prefix=$(sed -n "${ln}p" <<< "$INPUT" | sed -E 's/^\[([^\]]*)\].*/\1/')

                # å€¤æŠ½å‡ºï¼ˆ() ã‚­ãƒ£ãƒ—ãƒãƒ£ã‚’ $1 ã¨ã—ã¦å–ã‚Šå‡ºã™ï¼‰
                local VAL=$(printf "%s" "$line" | perl -CS -pe "s/${RULE}/\$1/")
                VAL=$(printf "%s" "$VAL" | perl -CS -pe 'tr/ï¼-ï¼™/0-9/')

                OUT+="${prefix}${VAL}"$'\n'
              done <<< "$MATCH_LINES"
            fi

            printf "%s" "$OUT"
          }

          while read SITE; do
            NAME=$(echo "$SITE" | jq -r '.name')
            URL=$(echo "$SITE" | jq -r '.url')
            RULES=$(echo "$SITE" | jq -r '.rules')

            echo "[INFO] Processing $NAME ($URL)"

            # HTMLå–å¾— & ãƒ†ã‚­ã‚¹ãƒˆåŒ–
            curl -s "$URL" > "pages/${NAME}.html"
            TEXT_RAW=$(sed 's/<[^>]*>//g' "pages/${NAME}.html")

            # ğŸŸ¦ åˆå‰/åˆå¾Œã‚»ã‚¯ã‚·ãƒ§ãƒ³ã§ annotate
            TEXT=$(annotate_section "$TEXT_RAW")
            echo "$TEXT" > "pages/${NAME}.txt"

            # ---- å„ãƒ«ãƒ¼ãƒ«ã«å¯¾ã—ã¦ãƒãƒƒãƒãƒ³ã‚° ----
            RULE_MATCHES=""
            while IFS="=" read -r RULE_NAME RULE_PATTERN; do
              MATCH_RESULT=$(extract_matches "$RULE_PATTERN" "$TEXT")
              if [ -n "$MATCH_RESULT" ]; then
                INDENTED=$(printf "%s" "$MATCH_RESULT" | sed 's/^/  - /')
                RULE_MATCHES+="ãƒ»$RULE_NAME:\n$INDENTED"$'\n'
              fi
            done <<< "$(echo "$RULES" | jq -r 'to_entries | .[] | "\(.key)=\(.value)"')"

            echo "[DEBUG][$NAME] Matched rules:"
            echo "$RULE_MATCHES"

            # JSONã«ä¿å­˜ï¼ˆå·®åˆ†åˆ¤å®šç”¨ï¼‰
            NEW_STATE_FILE="results/${NAME}_state.json.new"
            jq -n --arg r "$RULE_MATCHES" '{rules:$r}' > "$NEW_STATE_FILE"

            STATE_FILE="results/${NAME}_state.json"
            CHANGE_FLAG="results/${NAME}_changed.flag"

            # å·®åˆ†æ¯”è¼ƒ
            if [ ! -f "$STATE_FILE" ] || [ "$(jq -S . "$STATE_FILE")" != "$(jq -S . "$NEW_STATE_FILE")" ]; then
              echo "changed" > "$CHANGE_FLAG"
            fi

          done < sites_list.txt

      - name: Notify Slack for changed sites
        run: |
          while read SITE; do
            NAME=$(echo "$SITE" | jq -r '.name')
            URL=$(echo "$SITE" | jq -r '.url')
            CHANGE_FLAG="results/${NAME}_changed.flag"
            [ -f "$CHANGE_FLAG" ] || continue

            STATE_NEW="results/${NAME}_state.json.new"
            RULE_MATCHES=$(jq -r '.rules' "$STATE_NEW")

            # å…¨é …ç›®ç©ºãªã‚‰é€šçŸ¥ã—ãªã„
            if [ -z "$RULE_MATCHES" ]; then
              echo "[INFO] Skip Slack: no matched rules for $NAME"
              continue
            fi

            # ãƒ«ãƒ¼ãƒ«åã¨å€¤ã‚’ã‚³ãƒ­ãƒ³åŒºåˆ‡ã‚Šã§è¡¨ç¤º
            MESSAGE="*${NAME}*\nç•ªå·ãŒæ›´æ–°ã•ã‚Œã¾ã—ãŸ\n${RULE_MATCHES}\n${URL}"

            curl -X POST -H 'Content-type: application/json' \
              --data "{ \"channel\": \"#${NAME}\", \"text\": \"${MESSAGE}\" }" \
              "${{ secrets.SLACK_WEBHOOK_URL }}"

            curl -X POST \
              -H "Content-Type: application/json" \
              --data "{ \"text\": \"${MESSAGE}\" }" \
              "${{ secrets.PHONE_HOOK_URL }}" 

          done < sites_list.txt

      - name: Save new states
        run: |
          while read SITE; do
            NAME=$(echo "$SITE" | jq -r '.name')
            mv "results/${NAME}_state.json.new" "results/${NAME}_state.json"
          done < sites_list.txt

          git config user.name github-actions
          git config user.email github-actions@github.com
          git add results
          git commit -m "Update states" || true
          git push || true

      - name: Upload debug artifacts
        uses: actions/upload-artifact@v4
        with:
          name: debug-pages
          path: |
            pages/
            results/
