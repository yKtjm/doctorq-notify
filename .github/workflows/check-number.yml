name: Check DoctorQube Numbers (Multi-site Debug)

on:
  workflow_dispatch:
  schedule:
    - cron: "*/5 * * * *"

jobs:
  check:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v3

      - name: Install jq
        run: sudo apt-get install -y jq

      - name: Load sites.json
        id: load_sites
        run: |
          echo "SITES=$(cat sites.json)" >> $GITHUB_ENV

      - name: Process all sites
        run: |
          echo "$SITES" | jq -c '.[]' | while read SITE; do
            NAME=$(echo "$SITE" | jq -r '.name')
            URL=$(echo "$SITE" | jq -r '.url')

            RULE_CURRENT=$(echo "$SITE" | jq -r '.rules.current')
            RULE_ABSENT=$(echo "$SITE" | jq -r '.rules.absent')
            RULE_NEXT=$(echo "$SITE" | jq -r '.rules.next')

            echo "=============================="
            echo " Processing site: $NAME"
            echo " URL: $URL"
            echo "=============================="

            curl -s "$URL" > page.html

            echo "[DEBUG] Saved page.html (first 200 lines):"
            head -n 200 page.html || true

            # HTML → テキスト
            TEXT=$(sed 's/<[^>]*>//g' page.html)
            echo "$TEXT" > page.txt

            echo "----- BEGIN DEBUG: page.txt (先頭200行) -----"
            head -n 200 page.txt || true
            echo "----- END DEBUG: page.txt -----"

            echo
            echo "----- DUMP: full TEXT (警告: 長い場合あり) -----"
            printf '%s\n' "$TEXT"
            echo "----- END DUMP -----"
            echo

            # 全角 → 半角変換関数
            z2h() {
              echo "$1" | tr '０１２３４５６７８９' '0123456789'
            }

            # 抽出
            RAW_CURRENT=$(echo "$TEXT" | grep -oP "$RULE_CURRENT" | head -n 1 || true)
            CURRENT=$(z2h "$RAW_CURRENT" | tr -d ' ')

            RAW_ABSENT=$(echo "$TEXT" | grep -oP "$RULE_ABSENT" | head -n 1 || true)
            ABSENT=$(z2h "$RAW_ABSENT" | tr '、' ',' | tr -d ' ')

            RAW_NEXT=$(echo "$TEXT" | grep -oP "$RULE_NEXT" | head -n 1 || true)
            NEXT=$(z2h "$RAW_NEXT" | tr -d ' ')

            echo "DEBUG_RAW_CURRENT: '$(printf "%s" "$RAW_CURRENT")'"
            echo "DEBUG_CURRENT     : '$(printf "%s" "$CURRENT")'"
            echo "DEBUG_RAW_ABSENT  : '$(printf "%s" "$RAW_ABSENT")'"
            echo "DEBUG_ABSENT      : '$(printf "%s" "$ABSENT")'"
            echo "DEBUG_RAW_NEXT    : '$(printf "%s" "$RAW_NEXT")'"
            echo "DEBUG_NEXT        : '$(printf "%s" "$NEXT")'"

            # サイト別 state ファイル
            STATE_FILE="state_${NAME}.json"

            if [ -f "$STATE_FILE" ]; then
              PREV=$(cat "$STATE_FILE")
            else
              PREV="{}"
            fi

            NEW="{\"current\": \"$CURRENT\", \"absent\": \"$ABSENT\", \"next\": \"$NEXT\"}"

            echo "PREVIOUS STATE = $PREV"
            echo "NEW STATE      = $NEW"

            if [ "$NEW" != "$PREV" ]; then
              echo ">>> CHANGE DETECTED for $NAME"
              echo "$NEW" > "$STATE_FILE"

              # Slack通知（チャンネル名 = NAME）
              TEXT_MSG="[$NAME] 番号が更新されました。\n*診療中:* $CURRENT\n*ご不在:* $ABSENT\n*次にお取りできる番号:* $NEXT"

              curl -X POST \
                -H "Content-type: application/json" \
                --data "{\"channel\":\"$NAME\", \"text\":\"$TEXT_MSG\"}" \
                "${{ secrets.SLACK_WEBHOOK_URL }}"
            else
              echo "No change for $NAME"
            fi

            # デバッグ用アーティファクトとして保存
            mkdir -p artifacts/$NAME
            cp page.html artifacts/$NAME/
            cp page.txt  artifacts/$NAME/
            echo "$NEW" > artifacts/$NAME/state.json

          done

      - name: Upload debug artifacts
        uses: actions/upload-artifact@v4
        with:
          name: debug-pages
          path: artifacts/

      - name: Commit updated states
        run: |
          git config user.name github-actions
          git config user.email github-actions@github.com
          git add state_*.json || true
          git commit -m "Update state files" || true
          git push
