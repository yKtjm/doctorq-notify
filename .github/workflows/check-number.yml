name: Check DoctorQube Number (Debug)

on:
  workflow_dispatch:   # 手動実行でデバッグしやすくする
  schedule:
    - cron: "*/5 * * * *"

jobs:
  check:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v3

      - name: Fetch page
        run: |
          curl -s https://ssc11.doctorqube.com/morimoto-kids/ > page.html
          ls -l page.html
          echo "[DEBUG] Saved page.html (first 200 lines):"
          head -n 200 page.html || true

      - name: Extract numbers from HTML (with Zenkaku → Hankaku conversion) and debug output
        env:
          GITHUB_ENV: ${{ github.env }}
        run: |
          set -euo pipefail

          # 全角 → 半角変換関数
          z2h() {
            echo "$1" | tr '０１２３４５６７８９' '0123456789'
          }

          # HTML → テキスト（タグ除去）
          TEXT=$(sed 's/<[^>]*>//g' page.html)
          # 保存してログ出力（アーティファクトとしてもアップロード）
          echo "$TEXT" > page.txt

          echo "----- BEGIN DEBUG: page.txt (先頭200行) -----"
          head -n 200 page.txt || true
          echo "----- END DEBUG: page.txt -----"

          # デバッグ向けに全文を出力（ログが大きくなりすぎる場合は縮める）
          echo
          echo "----- DUMP: full TEXT (警告: 長い場合あり) -----"
          printf '%s\n' "$TEXT"
          echo "----- END DUMP -----"
          echo

          # 診療中（RAW: 全角も含む）
          RAW_CURRENT=$(echo "$TEXT" | grep -oP '診療中\s*\K[０-９０-９0-9]+' | head -n 1 || true)
          CURRENT=$(z2h "$RAW_CURRENT" | tr -d ' ')

          # ご不在の方（RAW: 全角カンマ・読点 等を含む場合あり）
          RAW_ABSENT=$(echo "$TEXT" | grep -oP 'ご不在の方\s*\K[０-９０-９0-9,、\s]+' | head -n 1 || true)
          ABSENT=$(z2h "$RAW_ABSENT" | tr '、' ',' | tr -d ' ')

          # 次にお取りできる番号（RAW）
          RAW_NEXT=$(echo "$TEXT" | grep -oP '次にお取りできる番号\s*\K[０-９０-９0-9]+' | head -n 1 || true)
          NEXT=$(z2h "$RAW_NEXT" | tr -d ' ')

          # 出力してログに表示（改行や空文字も分かるように表現）
          echo "DEBUG_RAW_CURRENT: '$(printf "%s" "$RAW_CURRENT")'"
          echo "DEBUG_CURRENT      : '$(printf "%s" "$CURRENT")'"
          echo "DEBUG_RAW_ABSENT  : '$(printf "%s" "$RAW_ABSENT")'"
          echo "DEBUG_ABSENT      : '$(printf "%s" "$ABSENT")'"
          echo "DEBUG_RAW_NEXT    : '$(printf "%s" "$RAW_NEXT")'"
          echo "DEBUG_NEXT        : '$(printf "%s" "$NEXT")'"

          # 環境変数へセット（元のフローと互換）
          echo "CURRENT=$CURRENT" >> $GITHUB_ENV
          echo "ABSENT=$ABSENT" >> $GITHUB_ENV
          echo "NEXT=$NEXT" >> $GITHUB_ENV

      - name: Show environment vars (check)
        run: |
          echo "[ENV] CURRENT=${CURRENT}"
          echo "[ENV] ABSENT=${ABSENT}"
          echo "[ENV] NEXT=${NEXT}"

      - name: Save debug artifacts (page.html, page.txt)
        uses: actions/upload-artifact@v4
        with:
          name: debug-pages
          path: |
            page.html
            page.txt

      - name: Load previous state
        run: |
          if [ -f last_state.json ]; then
            PREV=$(cat last_state.json)
          else
            PREV="{}"
          fi
          echo "PREV_STATE=$PREV" >> $GITHUB_ENV

      - name: Compare state
        run: |
          NEW="{\"current\": \"$CURRENT\", \"absent\": \"$ABSENT\", \"next\": \"$NEXT\"}"
          echo "$NEW" > new_state.json

          if [ ! -f last_state.json ] || [ "$(cat last_state.json)" != "$NEW" ]; then
            echo "changed" > changed.flag
          fi

      - name: Notify Slack (on change)
        if: hashFiles('changed.flag') != ''
        run: |
          TEXT="番号が更新されました。\n*診療中:* $CURRENT\n*ご不在:* $ABSENT\n*次にお取りできる番号:* $NEXT"
          curl -X POST -H 'Content-type: application/json' --data "{\"text\":\"$TEXT\"}" "${{ secrets.SLACK_WEBHOOK_URL }}"

      - name: Save new state
        run: |
          mv new_state.json last_state.json
          git config user.name github-actions
          git config user.email github-actions@github.com
          git add last_state.json
          git commit -m "Update state" || true
          git push
